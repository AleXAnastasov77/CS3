{% extends "base.html" %}
{% block title %}Employees{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-semibold text-gray-700">Employees</h1>

    <a href="{{ url_for('new_employee') }}"
       class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        + Add Employee
    </a>
</div>

<div class="bg-white shadow-md rounded">
    <table class="min-w-full table-fixed border-collapse" id="employees-table">

        <colgroup>
            <col class="w-1/6">   <!-- Name -->
            <col class="w-1/6">   <!-- Email -->
            <col class="w-1/6">   <!-- Department -->
            <col class="w-1/6">   <!-- AD Username -->
            <col class="w-1/6">   <!-- VM -->
            <col class="w-1/12">  <!-- Provisioning -->
            <col class="w-1/12">  <!-- Actions -->
        </colgroup>

        <thead class="bg-gray-200 text-gray-700">
            <tr>
                <th class="px-4 py-2 text-left">Name</th>
                <th class="px-4 py-2 text-left">Email</th>
                <th class="px-4 py-2 text-left">Department</th>
                <th class="px-4 py-2 text-left">AD Username</th>
                <th class="px-4 py-2 text-left">VM</th>
                <th class="px-4 py-2 text-center">Provisioning</th>
                <th class="px-4 py-2 text-center">Actions</th>
            </tr>
        </thead>

        <tbody id="employees-body" class="divide-y divide-gray-100"></tbody>

    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    if (!localStorage.getItem("hr_jwt")) {
        window.location.href = "/login";
    }
});

async function loadEmployees() {
    const token = getToken();
    if (!token) {
        window.location.href = "/login";
        return;
    }

    const resp = await fetch(API_BASE + "/api/employees", {
        headers: { "Authorization": "Bearer " + token }
    });

    if (resp.status === 401) {
        setToken(null);
        window.location.href = "/login";
        return;
    }

    const data = await resp.json();
    renderEmployees(data);
}

function formatStatus(s) {
    if (!s || s === "active") return '<span class="text-gray-400">—</span>';
    if (s.startsWith("failed")) return '<span class="text-red-600 font-semibold">Failed</span>';
    if (s === "completed") return '<span class="text-green-600 font-semibold">Completed</span>';
    return `<span class="text-blue-600">${s.replace(/_/g, " ")}</span>`;
}

function renderEmployees(employees) {
    const tbody = document.getElementById("employees-body");
    tbody.innerHTML = "";

    employees.forEach(e => {
        const tr = document.createElement("tr");
        tr.className = "border-b";

        tr.innerHTML = `
            <td class="px-4 py-2">${e.first_name} ${e.last_name}</td>
            <td class="px-4 py-2">${e.email}</td>
            <td class="px-4 py-2 text-center">${e.department_name}</td>
            <td class="px-4 py-2 text-center">${e.ad_username}</td>
            <td class="px-4 py-2 text-center">${e.vm_name || "-"}</td>
            <td class="px-4 py-2 text-center">${formatStatus(e.status)}</td>
            <td class="px-4 py-2 text-center">
                ${e.status !== "deactivated"
                    ? '<button data-id="'+e.id+'" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 deactivate-btn">Deactivate</button>'
                    : '<span class="text-gray-400">—</span>'}
            </td>
        `;

        tbody.appendChild(tr);
    });

    document.querySelectorAll(".deactivate-btn").forEach(btn => {
        btn.addEventListener("click", () => deactivateEmployee(btn.dataset.id));
    });
}

async function deactivateEmployee(id) {
    const token = getToken();
    if (!token) {
        window.location.href = "/login";
        return;
    }

    if (!confirm("Deactivate this employee?")) return;

    const resp = await fetch(API_BASE + `/api/employees/${id}/deactivate`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await resp.json();

    if (!resp.ok) {
        showFlash(data.error || "Failed to deactivate employee", "error");
        return;
    }

    showFlash("Employee deactivated");
    loadEmployees();
}

document.addEventListener("DOMContentLoaded", loadEmployees);
</script>
{% endblock %}

